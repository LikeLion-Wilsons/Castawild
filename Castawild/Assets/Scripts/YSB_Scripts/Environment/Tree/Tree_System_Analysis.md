# 나무 시스템(Tree System) 코드 분석

이 문서는 프로젝트의 나무 생성 및 관리 시스템을 구성하는 스크립트들의 역할과 상_호작용을 설명합니다.

## 시스템 아키텍처 개요

이 시스템은 **데이터(Data)**, **개별 개체(Individual Object)**, **관리자(Manager)**의 역할이 명확하게 분리된 효율적인 구조를 가집니다.

1.  **`TreeDefinition` (데이터):** `ScriptableObject`를 사용하여 나무의 종류별 특성(체력, 드랍 아이템, 프리팹 등)을 정의합니다. 이를 통해 코드 수정 없이 게임 디자이너가 나무의 데이터를 쉽게 수정할 수 있습니다.
2.  **`TreeHealth` (개별 개체):** 실제 게임 씬에 존재하는 나무 게임 오브젝트에 부착되어, 각 나무의 상태(예: 체력)를 관리하고 피해를 받거나 파괴되는 등의 핵심 로직을 처리합니다.
3.  **`TreeManager` (관리자):** 씬에 존재하는 모든 나무를 총괄합니다. **오브젝트 풀링(Object Pooling)**을 사용해 나무를 효율적으로 재활용하고, **어드레서블(Addressables)** 시스템으로 프리팹을 비동기 로딩하며, 지정된 규칙에 따라 터레인 위에 나무를 **절차적으로 생성(Procedural Generation)**하는 역할을 담당합니다.
4.  **`TreeSource` (헬퍼):** 오브젝트 풀링 시스템에서 파괴된 나무가 어떤 종류의 풀(Pool)로 돌아가야 하는지 알려주는 '이름표' 역할을 하는 간단하지만 필수적인 스크립트입니다.

---

## 스크립트별 상세 분석

### 1. `TreeDefinition.cs`

*   **핵심 역할:** 나무의 모든 속성을 정의하는 데이터 컨테이너. `ScriptableObject`이므로 에셋 형태로 존재합니다.
*   **주요 변수:**
    *   `treeName`: 나무의 이름 (예: "참나무", "소나무").
    *   `prefabReference`: 어드레서블 시스템을 통해 로드할 나무의 원본 프리팹 주소.
    *   `maxHealth`: 나무의 최대 체력.
    *   `dropItemID`, `dropAmount`: 파괴되었을 때 드랍할 아이템의 종류와 수량.
    *   `destroySFX`, `destroyVFX`: 파괴 시 재생할 사운드 및 시각 효과의 어드레서블 키.

### 2. `TreeHealth.cs`

*   **핵심 역할:** 개별 나무 게임 오브젝트의 생명 주기를 관리합니다.
*   **주요 로직:**
    *   `Init()`: `TreeManager`에 의해 나무가 스폰될 때 호출됩니다. `TreeDefinition` 데이터를 받아와 자신의 최대 체력 등을 초기화합니다.
    *   `TakeDamage(float damage)`: 외부(예: 플레이어의 공격)로부터 데미지를 받으면 호출됩니다. 현재 체력을 감소시키고, 체력이 0 이하가 되면 `Die()` 메소드를 호출합니다.
    *   `Die()`: 나무가 파괴될 때의 로직을 처리합니다.
        1.  `TreeDefinition`에 명시된 아이템을 드랍합니다 (현재는 로그만 출력).
        2.  파괴 효과음 및 시각 효과를 재생합니다 (현재는 주석 처리).
        3.  `OnTreeDied` 이벤트를 호출하여 자신의 파괴 사실을 `TreeManager`에게 알립니다.
    *   `OnTreeDied` (Action): `TreeManager`가 이 이벤트를 구독(Subscribe)하고 있다가, 나무가 파괴되면 `OnTreeDestroyed` 콜백 함수를 실행하여 해당 나무를 풀에 반납하는 등의 후속 처리를 합니다.

### 3. `TreeManager.cs`

*   **핵심 역할:** 씬의 모든 나무를 총괄하는 컨트롤 타워.
*   **주요 기능:**
    *   **오브젝트 풀링 (Object Pooling):**
        *   `InitializePools()`: 게임 시작 시 `TreeDefinition`에 명시된 종류별로 나무 프리팹을 미리 생성하여 풀(`treePools`)에 보관합니다.
        *   `SpawnTreeFromPool()`: 풀에서 비활성화된 나무를 가져와 사용합니다. 풀이 비어있으면 새로 생성합니다.
        *   `ReturnTreeToPool()`: 파괴된 나무를 다시 비활성화하여 풀에 반납합니다.
    *   **절차적 생성 (Procedural Spawning):**
        *   `MaintainTreePopulation()`: `populationCheckInterval`마다 주기적으로 실행되는 코루틴. 씬의 나무 개체 수가 `maxTrees`보다 적으면 `TrySpawnSingleTree`를 호출하여 보충합니다.
        *   `TrySpawnSingleTree()`: 나무를 스폰하기 위해 여러 조건을 검사합니다 (최소 높이, 다른 나무와의 최소 거리, 터레인의 특정 텍스처 위인지 등).
    *   **어드레서블 연동:**
        *   `LoadTreePrefabs()`: 게임 시작 시 `TreeDefinition`에 등록된 프리팹들을 어드레서블을 통해 비동기적으로 로딩하여 끊김 현상을 방지합니다.

### 4. `TreeSource.cs`

*   **핵심 역할:** 오브젝트 풀링 시스템을 위한 '출신 성분' 또는 '이름표' 스크립트.
*   **동작 원리:**
    1.  `TreeManager`가 특정 프리팹(예: 참나무 프리팹)으로 나무를 스폰할 때, 해당 나무 게임 오브젝트에 `TreeSource` 컴포넌트를 추가하고 `prefabOrigin` 변수에 '참나무 프리팹' 정보를 저장합니다.
    2.  나중에 이 참나무가 파괴되어 풀로 돌아가야 할 때, `TreeManager`는 이 나무의 `TreeSource`를 보고 `prefabOrigin`이 '참나무 프리팹'인 것을 확인합니다.
    3.  이 정보를 이용해 여러 나무 풀 중에서 정확히 '참나무 풀'을 찾아 나무를 반납합니다.
*   **중요성:** 이 스크립트가 없으면, 파괴된 나무가 어떤 종류의 나무였는지 알 수 없어서 올바른 풀에 반납할 수 없게 됩니다. 따라서 여러 종류의 오브젝트를 풀링할 때 필수적입니다.
